<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Synthetic Cities QC</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>
  <style>
    html,body,#map{height:100%;margin:0}
    #map{position:absolute;inset:0}
    .panel{position:absolute;left:12px;top:12px;z-index:1;background:rgba(255,255,255,.92);padding:10px 12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.15);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:14px;line-height:1.3;max-width:360px}
    .panel h1{margin:0 0 6px;font-size:16px}
    .row{display:flex;align-items:center;gap:8px;margin:6px 0}
    input[type=range]{width:160px}
    .attribution{position:absolute;right:10px;bottom:10px;background:rgba(255,255,255,.88);padding:4px 8px;border-radius:6px;font-size:12px}
    .popup{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:13px;line-height:1.35}
    .popup h3{margin:0 0 4px;font-size:14px}
    .dim{color:#6b7280}
  </style>
</head>
<body>
<div id="map"></div>

<div class="panel">
  <h1>synthetic_city_qc â€” WMS overlay</h1>
  <div class="row">
    <input id="toggle" type="checkbox" checked>
    <label for="toggle">Show overlay</label>
  </div>
  <div class="row">
    <label for="opacity">Opacity</label>
    <input id="opacity" type="range" min="0" max="1" step="0.05" value="0.85">
    <span id="opacityValue">0.85</span>
  </div>
  <div class="row dim">Click a polygon to identify. Scroll zoom is enabled.</div>
</div>
<div class="attribution">Basemap: Mapbox. Overlay: GeoServer region:synthetic_city_qc</div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiaGFwdXR5IiwiYSI6ImNqZGNleTVnYjBpZDIycXM0b2ptdTVpZnIifQ.SQ8jV9GmA78fpzumnn23-Q';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [-98.5, 39.8],
    zoom: 3.6,
    hash: true
  });

  // Ensure scroll zoom is active
  map.scrollZoom.enable();
  map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-right');
  map.addControl(new mapboxgl.ScaleControl({ unit: 'imperial' }));

  // WMS raster source
  const wmsBase = 'https://dev-geoserver.zartico.com/geoserver/region/wms';
  const LAYER_NAME = 'region:synthetic_city_qc';

  const wmsParams = new URLSearchParams({
    service: 'WMS',
    request: 'GetMap',
    version: '1.1.1',
    layers: LAYER_NAME,
    styles: '',
    format: 'image/png',
    transparent: 'true',
    srs: 'EPSG:3857',
    width: '256',
    height: '256'
  });
  const tiles = [`${wmsBase}?${wmsParams.toString()}&bbox={bbox-epsg-3857}`];

  function addWms() {
    if (!map.getSource('synthetic-city-wms')) {
      map.addSource('synthetic-city-wms', { type: 'raster', tiles, tileSize: 256, attribution: 'GeoServer region:synthetic_city_qc' });
    }
    if (!map.getLayer('synthetic-city')) {
      const labelLayer = map.getStyle().layers.find(l => l.type === 'symbol' && l.layout && l.layout['text-field'])?.id;
      map.addLayer({ id: 'synthetic-city', type: 'raster', source: 'synthetic-city-wms', paint: { 'raster-opacity': 0.85 } }, labelLayer);
    }
  }
  map.on('style.load', addWms);

  // Build a WMS GetFeatureInfo URL for the click location
  function buildGetFeatureInfoUrl(point) {
    // Use WMS 1.1.1 with EPSG:4326 to avoid manual WebMercator math
    const bounds = map.getBounds();
    const width = map.getCanvas().width;
    const height = map.getCanvas().height;
    const params = new URLSearchParams({
      service: 'WMS',
      request: 'GetFeatureInfo',
      version: '1.1.1',
      srs: 'EPSG:4326',
      bbox: `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`,
      height: String(height),
      width: String(width),
      layers: LAYER_NAME,
      query_layers: LAYER_NAME,
      styles: '',
      info_format: 'application/json',
      feature_count: '5',
      x: String(Math.round(point.x)),
      y: String(Math.round(point.y))
    });
    return `${wmsBase}?${params.toString()}`;
  }

  const popup = new mapboxgl.Popup({ closeButton: true, closeOnClick: true, className: 'popup' });

  map.on('click', async (e) => {
    try {
      const url = buildGetFeatureInfoUrl(e.point);
      const res = await fetch(url, { mode: 'cors' });
      if (!res.ok) throw new Error(`GetFeatureInfo HTTP ${res.status}`);
      const data = await res.json();
      const f = data.features && data.features[0];
      if (!f) { popup.setLngLat(e.lngLat).setHTML('No feature found.').addTo(map); return; }
      const p = f.properties || {};
      const name = p.synthetic_city_name || p.city_name || '(no name)';
      const klass = p.class_type || p.class || '(no class)';
      const tract = p.census_tract_fips || p.tract_fips || '';
      popup.setLngLat(e.lngLat).setHTML(`
        <h3>${name}</h3>
        <div><strong>Class type:</strong> ${klass}</div>
        ${tract ? `<div><strong>Tract FIPS:</strong> ${tract}</div>` : ''}
      `).addTo(map);
    } catch (err) {
      console.error(err);
      popup.setLngLat(e.lngLat).setHTML('Identify failed. Check CORS and info_format settings.').addTo(map);
    }
  });

  // UI controls
  const toggle = document.getElementById('toggle');
  const slider = document.getElementById('opacity');
  const val = document.getElementById('opacityValue');

  toggle.addEventListener('change', () => {
    const vis = toggle.checked ? 'visible' : 'none';
    if (map.getLayer('synthetic-city')) map.setLayoutProperty('synthetic-city', 'visibility', vis);
  });
  slider.addEventListener('input', () => {
    val.textContent = slider.value;
    if (map.getLayer('synthetic-city')) map.setPaintProperty('synthetic-city', 'raster-opacity', parseFloat(slider.value));
  });

  map.on('error', e => {
    if (String(e?.error).includes('cross-origin')) {
      console.warn('CORS blocked the WMS request. Enable CORS on GeoServer or proxy the WMS.');
    }
  });
</script>
</body>
</html>
