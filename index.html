<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>County Progress â€” Mapbox + GeoServer WMS</title>
  <!-- Mapbox GL JS v3 (CSS + JS) -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { position: absolute; inset: 0; }
    .panel {
      position: absolute; top: 12px; left: 12px; z-index: 1;
      background: rgba(255,255,255,0.92);
      padding: 10px 12px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      font-size: 14px; line-height: 1.3; color: #1f2937;
      max-width: 320px;
    }
    .panel h1 { font-size: 16px; margin: 0 0 6px; font-weight: 600; }
    .row { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
    label { white-space: nowrap; }
    input[type="range"] { width: 160px; }
    .note { font-size: 12px; color: #4b5563; margin-top: 6px; }
    .badge { display: inline-block; padding: 2px 6px; font-size: 12px; border-radius: 999px; background: #eef2ff; color: #3730a3; }
    .attribution { position: absolute; right: 10px; bottom: 10px; background: rgba(255,255,255,0.88); padding: 4px 8px; border-radius: 6px; font-size: 12px; }
    a { color: #0e76a8; text-decoration: none; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h1>County Progress WMS <span class="badge">WMS overlay</span></h1>
    <div class="row">
      <input id="toggle" type="checkbox" checked />
      <label for="toggle">Show overlay</label>
    </div>
    <div class="row">
      <label for="opacity">Opacity</label>
      <input id="opacity" type="range" min="0" max="1" step="0.05" value="0.85" />
      <span id="opacityValue">0.85</span>
    </div>
  </div>

  <div class="attribution">Data: <a href="https://dev-geoserver.zartico.com/geoserver/regions/wms" target="_blank" rel="noopener">GeoServer WMS</a>. Basemap: Mapbox.</div>

  <script>
    // 1) Mapbox credentials and style
    mapboxgl.accessToken = 'pk.eyJ1IjoiaGFwdXR5IiwiYSI6ImNqZGNleTVnYjBpZDIycXM0b2ptdTVpZnIifQ.SQ8jV9GmA78fpzumnn23-Q';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/haputy/cmekc6a6o012901s4en8x2ruf',
      center: [-98.5, 39.8], // CONUS
      zoom: 3.4,
      hash: true,
      cooperativeGestures: true
    });

    map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-right');
    map.addControl(new mapboxgl.ScaleControl({ unit: 'imperial' }));

    // 2) Add GeoServer WMS as a raster source
    // Use EPSG:3857 and the {bbox-epsg-3857} token so Mapbox GL can request tiles correctly.
    const wmsBase = 'https://dev-geoserver.zartico.com/geoserver/regions/wms';

    const wmsParams = new URLSearchParams({
      service: 'WMS',
      request: 'GetMap',
      version: '1.1.1',
      layers: 'regions:county_progress',
      styles: '',
      format: 'image/png',
      transparent: 'true',
      srs: 'EPSG:3857',
      width: '256',
      height: '256'
    });

    const tileTemplate = `${wmsBase}?${wmsParams.toString()}&bbox={bbox-epsg-3857}`;

    function addWmsOverlay() {
      if (!map.getSource('county-progress-wms')) {
        map.addSource('county-progress-wms', {
          type: 'raster',
          tiles: [tileTemplate],
          tileSize: 256,
          attribution: 'GeoServer regions:county_progress'
        });
      }

      if (!map.getLayer('county-progress')) {
        // Insert the WMS below labels to keep place names readable
        const labelLayerId = map.getStyle().layers.find(l => l.type === 'symbol' && l.layout && l.layout['text-field'])?.id;
        map.addLayer({
          id: 'county-progress',
          type: 'raster',
          source: 'county-progress-wms',
          paint: { 'raster-opacity': 0.85 }
        }, labelLayerId);
      }
    }

    map.on('style.load', () => {
      addWmsOverlay();
    });

    // 3) UI handlers for overlay visibility and opacity
    const toggle = document.getElementById('toggle');
    const slider = document.getElementById('opacity');
    const val = document.getElementById('opacityValue');

    toggle.addEventListener('change', () => {
      const vis = toggle.checked ? 'visible' : 'none';
      if (map.getLayer('county-progress')) map.setLayoutProperty('county-progress', 'visibility', vis);
    });

    slider.addEventListener('input', () => {
      val.textContent = slider.value;
      if (map.getLayer('county-progress')) map.setPaintProperty('county-progress', 'raster-opacity', parseFloat(slider.value));
    });

    // 4) Basic error logging to help with CORS or WMS issues
    map.on('error', (e) => {
      if (e && e.error && String(e.error).includes('cross-origin')) {
        console.warn('CORS blocked the WMS request. Enable CORS on GeoServer or proxy the WMS.');
      }
    });
  </script>
</body>
</html>
