<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Internal Data Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <style>
    #map { height: 100vh; width: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.gridlayer.googlemutant/Leaflet.GoogleMutant.js"></script>

  <script>
    const map = L.map('map', { center: [39.142, -84.4388], zoom: 12 });

    const mapbox = L.tileLayer('https://api.mapbox.com/styles/v1/haputy/cm8g29e6v000v01sa4om903i0/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiaGFwdXR5IiwiYSI6ImNqZGNleTVnYjBpZDIycXM0b2ptdTVpZnIifQ.SQ8jV9GmA78fpzumnn23-Q', {
      attribution: '© OpenStreetMap, © Mapbox',
      tileSize: 512,
      zoomOffset: -1
    });

    const googleHybrid = L.gridLayer.googleMutant({ type: 'hybrid' });

    mapbox.addTo(map);

    const wmsLayer = L.tileLayer.wms('https://dev-geoserver.zartico.com/geoserver/region/wms', {
      layers: 'region:butler_final',
      format: 'image/png',
      transparent: true,
      attribution: 'Zartico GeoServer'
    });

      function getRadius(value) {
  if (value >= 2500) return 100;
  if (value >= 1000) return 50;
  if (value >= 500) return 25;
  if (value >= 100) return 15;
  if (value >= 1) return 5;
  return 4; // fallback for 0 or missing values
}

    const poiCirclesLayer = L.geoJSON(null, {
      pointToLayer: () => null,
      style: () => null,
      onEachFeature: function (feature, layer) {
        const count = feature.properties.visitor_device_count || 1;
        let center;
        if (feature.geometry.type === "Polygon" || feature.geometry.type === "MultiPolygon") {
          const latlngs = L.GeoJSON.coordsToLatLngs(feature.geometry.coordinates, feature.geometry.type === "Polygon" ? 1 : 2);
          const polygon = L.polygon(latlngs);
          center = polygon.getBounds().getCenter();
        } else {
          center = layer.getLatLng();
        }
        const circle = L.circleMarker(center, {
          radius: getRadius(count),
          fillColor: "#0074D9",
          color: "#003366",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.6
        }).bindPopup(
          `<strong>${feature.properties.poi_name}</strong><br>` +
          `Visitor Count: ${count}<br>` +
          `Category: ${feature.properties.primary_category}`
        );
        circle.addTo(poiCirclesLayer);
      },
      filter: function (feature) {
        const val = feature.properties.visitor_device_count;
        return val >= 1 && val <= 82000;
      }
    });

    fetch(`https://dev-geoserver.zartico.com/geoserver/region/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=region:butler_final&outputFormat=application/json`)
      .then(res => res.json())
      .then(data => poiCirclesLayer.addData(data))
      .catch(err => console.error("Error loading graduated circles WFS:", err));

    const baseMaps = {
      "Mapbox Streets": mapbox,
      "Google Hybrid": googleHybrid
    };

    const overlayMaps = {
      "Butler Polygons (WMS)": wmsLayer,
      "Visitor Count Circles": poiCirclesLayer
    };

    L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);
  </script>
</body>
</html>
